##############################################################################
# SFTP Secure Ticket Service — Docker Compose
# ============================================================================
# Services:
#   - nginx       : Reverse proxy + TLS termination (443)
#   - app         : Flask backend API + static frontend
#   - openldap    : LDAP directory for user authentication
#   - redis       : Ticket store, session management, file metadata
#   - mailhog     : Development SMTP server (replace in production)
##############################################################################

version: '3.8'

services:
  # ── Nginx Reverse Proxy ──────────────────────────────────
  nginx:
    image: nginx:1.27-alpine
    container_name: sftp-nginx
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - sftp-network
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── Flask Application ────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile.app
    container_name: sftp-app
    environment:
      - SECRET_KEY=${SECRET_KEY:-$(openssl rand -hex 64)}
      - JWT_SECRET=${JWT_SECRET:-$(openssl rand -hex 64)}
      - JWT_EXPIRY_MINUTES=15
      - LDAP_URI=ldap://openldap:389
      - LDAP_BASE_DN=dc=sftp,dc=secure,dc=local
      - LDAP_USERS_DN=ou=users,dc=sftp,dc=secure,dc=local
      - LDAP_ADMIN_DN=cn=admin,dc=sftp,dc=secure,dc=local
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-admin_secret_change_me}
      - REDIS_URL=redis://redis:6379/0
      - SFTP_STORAGE_PATH=/data/sftp-storage
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - SMTP_FROM=sftp-service@secure.local
      - RSA_KEY_PATH=/data/keys/signing_key.pem
      - TICKET_TTL_SECONDS=300
    volumes:
      - sftp-storage:/data/sftp-storage
      - signing-keys:/data/keys
      - app-logs:/data/logs
    depends_on:
      openldap:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - sftp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  # ── OpenLDAP Directory ───────────────────────────────────
  openldap:
    image: osixia/openldap:1.5.0
    container_name: sftp-openldap
    environment:
      - LDAP_ORGANISATION=SFTP Secure Service
      - LDAP_DOMAIN=sftp.secure.local
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-admin_secret_change_me}
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD:-config_secret_change_me}
      - LDAP_TLS=false
      - LDAP_TLS_VERIFY_CLIENT=never
    volumes:
      - ldap-data:/var/lib/ldap
      - ldap-config:/etc/ldap/slapd.d
      - ./docker/ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/01-bootstrap.ldif:ro
    ports:
      - "389:389"
    restart: unless-stopped
    networks:
      - sftp-network
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=sftp,dc=secure,dc=local"]
      interval: 15s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Redis ────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: sftp-redis
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-redis_secret_change_me}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - sftp-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_secret_change_me}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M

  # ── MailHog (Dev SMTP — replace with real SMTP in production) ──
  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: sftp-mailhog
    ports:
      - "8025:8025"   # Web UI
    restart: unless-stopped
    networks:
      - sftp-network
    deploy:
      resources:
        limits:
          memory: 128M

# ── Volumes ──────────────────────────────────────────────────
volumes:
  sftp-storage:
    driver: local
  signing-keys:
    driver: local
  app-logs:
    driver: local
  ldap-data:
    driver: local
  ldap-config:
    driver: local
  redis-data:
    driver: local

# ── Network ──────────────────────────────────────────────────
networks:
  sftp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
